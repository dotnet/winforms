# Modernization of code behind in WinForms OOP designer

## Background

WinForms designer saves visual representations of user controls or forms on the design surface to code behind file(`Form1.Designer.cs` or `Form1.Designer.vb`). Control instances that developer sees on the design surface are represented as a CodeDOM tree (see [Using the CodeDOM](https://learn.microsoft.com/dotnet/framework/reflection-and-codedom/using-the-codedom)), that tree is saved to the generated code behind file in the `InitializeComponent` method. We call this feature design time serialization.

Up until Preview3, COM-based CodeModel interfaces (see [CodeModel Interface](https://learn.microsoft.com/dotnet/api/envdte.codemodel?view=visualstudiosdk-2022)) were used to write code into the editor's buffer as well as to generate CodeDOM tree from the source code when designer was loading. This COM object was accessible from the main thread only, which prevented parallelization in source code processing. Also, being more that 20 years old, it did not support some of the newer language features, for example the `nameof()` expression.

## The change

Starting with [Visual Studio 2022 v17.5 Preview 3](https://visualstudio.microsoft.com/vs/preview/), WinForms out-of-process designer uses [Roslyn](https://github.com/dotnet/roslyn) for design time serialization.

In Preview 3, designer serializes more modern code into `InitializeComponent`. We have worked hard to ensure that you can take projects between this version of Visual Studio and earlier versions. Someday in the future, we may build on the improvements in our serialization to enable performance enhancements and use newer language features. These potential future investments may break the backwards compatibility with earlier VS version - but we will be sure to inform our developers well ahead of such changes so that you can prepare.

## Wins

* The use of Roslyn unblocks multithreaded serialization and deserialization to solve performance delays in designer load and unload scenarios.
* Code behind generation now respects `.editorconfig` settings and thus matches code style in the source files.
* If developer enables implicit usings feature in the project properties, this option is respected by the code generation.
* Further modernization of code behind is unblocked now.
* Newly generated code will be compatible with modern Roslyn analyzers.

## Expected code behind differences after the first design time serialization

While `InitializeComponent` method is meant for the designer use only, and manual modifications to this method are not supported, developers might see some changes that are not related to your work in `Form1.Designer.cs` and `Form1.designer.vb` files when comparing versions in the source control tools. This is a one-time code churn, once designer file is regenerated, Preview 3 and newer will generate only the work-related code.

For example, `InitializeComponent` method for a form with a button will be modified like this:

![Comparison of Form1.Designer.cs as generated by Visual Studio 2022 v17.4 or earlier against the same file generated by v17.5 Preview3](../images/Form1-Designer-C#-comparison.png).

Code generated by VisualStudio v17.4 or earlier:

```cs
private void InitializeComponent()
{
    this.components = new System.ComponentModel.Container();
    this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
    this.ClientSize = new System.Drawing.Size(800, 450);
    this.Text = "Form1";
}
```

Code generated by VisualStudio v17.5 Preview 3, or newer:

```cs
private void InitializeComponent()
{
    button1 = new Button();
    SuspendLayout();
    // 
    // button1
    // 
    button1.Location = new Point(25, 32);
    button1.Name = "button1";
    button1.Size = new Size(75, 23);
    button1.TabIndex = 0;
    button1.Text = "button1";
    button1.UseVisualStyleBackColor = true;
    // 
    // Form1
    // 
    AutoScaleDimensions = new SizeF(7F, 15F);
    AutoScaleMode = AutoScaleMode.Font;
    ClientSize = new Size(163, 158);
    Controls.Add(button1);
    Name = "Form1";
    Text = "Form1";
    ResumeLayout(false);
}
```

### Support for code style settings

`this` access qualifier was removed in the Preview 3 version and code now matches the default style settings for C#.

To preserve legacy code generation style in `InitializeComponent` method, set style preferences to legacy values in [`.editorconfig` file](https://learn.microsoft.com/visualstudio/ide/create-portable-custom-editor-options).

```ini
# WinForms code behind files
[*.Designer.cs, *.Designer.vb]

# this. and Me. preferences
dotnet_style_qualification_for_event = true
dotnet_style_qualification_for_field = true
dotnet_style_qualification_for_method = true
dotnet_style_qualification_for_property = true
```

### Generated code honors implicit usings property

Namespace names were removed from the type names in the Preview 3 version. Namespaces are not needed because design time serialization looks up the [implicit usings](https://www.hanselman.com/blog/implicit-usings-in-net-6) property, available in C# starting with .NET 6 for C#, from the project file:

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWindowsForms>true</UseWindowsForms>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

</Project>
```

When implicit usings property is disabled in the C# project file, namespace names are generated, as they were previously.

### Similar changes are present in VB

![Comparison of Form1.Designer.vb as generated by Visual Studio 2022 v17.4 or earlier against the same file generated by v17.5 Preview3](./images/Form1-Designer-VB-comparison.png)

Code generated by VisualStudio v17.4 or earlier:

```vb
<System.Diagnostics.DebuggerStepThrough()> _
    Private Sub InitializeComponent()
        components = New System.ComponentModel.Container
        Me.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font
        Me.ClientSize = New System.Drawing.Size(800, 450)
        Me.Text = "Form2"
    End Sub
```

Code generated by VisualStudio v17.5 Preview 3, or newer:

```vb
 <System.Diagnostics.DebuggerStepThrough()> _
    Private Sub InitializeComponent()
        SuspendLayout()
        ' 
        ' Form2
        ' 
        AutoScaleDimensions = New SizeF(10.0F, 25.0F)
        AutoScaleMode = AutoScaleMode.Font
        ClientSize = New Size(223, 199)
        Name = "Form2"
        Text = "Form2"
        ResumeLayout(False)
    End Sub
```

## Summary

New code behind in WinForm looks differently because it follows code style settings defined for the project. Under the covers, design time serialization was redesigned and designer moved from `EnvDTE.CodeModel` to `Roslyn`. We are planning to build upon this foundation in the future Visual Studio releases. Code behind generated by the older releases will load into Preview 3 or later releases and will work as expected. Code behind generated by Preview 3 can be loaded in the previous releases of the Visual Studio, but we are considering generating modern code that might not be supported by the previous versions of deserializer.
