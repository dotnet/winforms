# Parameters ARE available in template expressions, and parameters can have default values,
# so they can be used to control yaml flow.

# trigger ci builds for completed checkins into main and any release branches
trigger:
- main
- release/*
- internal/release/*
- internal/experimental/*

# trigger ci builds on pull requests into main and any release branches
pr:
- main
- vnext
- release/*
- internal/release/*
- internal/experimental/*

variables:
  - name: TeamName
    value: DotNetCore
  # clean the local repo on the build agents
  - name: Build.Repository.Clean
    value: true
  - name: PostBuildSign
    value: true
  - name: EnableLoc
    value: false
  - name: NativeToolsOnMachine
    value: true

  # used for post-build phases, internal builds only
  - ${{ if ne(variables['System.TeamProject'], 'internal') }}:
    - name: _InternalRuntimeDownloadArgs
      value: ''
  - ${{ if eq(variables['System.TeamProject'], 'internal') }}:
    - group: DotNetBuilds storage account read tokens
    - group: AzureDevOps-Artifact-Feeds-Pats
    - name: _InternalRuntimeDownloadArgs
      value: >-
        /p:DotNetRuntimeSourceFeed=https://dotnetbuilds.blob.core.windows.net/internal
        /p:DotNetRuntimeSourceFeedKey=$(dotnetbuilds-internal-container-read-token-base64)

  # Produce test-signed build for PR and Public builds
  # needed for darc (dependency flow) publishing
  - name: _PublishArgs
    value: ''
  - name: _OfficialBuildIdArgs
    value: ''
  # needed for signing
  - name: _SignType
    value: test
  - name: _SignArgs
    value: ''
  - name: _Sign
    value: false

stages:

- stage: Build
  jobs:

  # Windows x64
  - template: /eng/pipelines/build-PR.yml
    parameters:
      name: Windows_x64
      targetArchitecture: x64

  # Windows x86
  - template: /eng/pipelines/build-PR.yml
    parameters:
      name: Windows_x86
      targetArchitecture: x86

  # Windows arm64
  - template: /eng/pipelines/build-PR.yml
    parameters:
      name: Windows_arm64
      targetArchitecture: arm64
